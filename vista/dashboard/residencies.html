<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resid√®ncies per a Gent Gran - Barcelona Open Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in { animation: slideIn 0.6s ease-out forwards; }
        body {
            background: linear-gradient(135deg, #fff5eb 0%, #fed7aa 100%);
        }
    </style>
</head>
<body class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 mb-6 border border-orange-200">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <div class="flex gap-2">
                            <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                            <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-yellow-600 rounded-full animate-pulse" style="animation-delay: 0.4s"></div>
                        </div>
                        <span class="text-sm font-bold text-orange-600 uppercase tracking-widest">Barcelona Open Data 2025</span>
                    </div>
                    <h1 class="text-4xl font-black text-orange-900">Resid√®ncies per a Gent Gran</h1>
                    <p class="text-orange-700 mt-2">Infraestructura residencial a Barcelona - #50opendata</p>
                </div>
                <div class="bg-gradient-to-br from-orange-500 to-amber-600 text-white px-8 py-5 rounded-2xl shadow-xl">
                    <div class="text-sm font-semibold opacity-90 mb-1">Total Resid√®ncies</div>
                    <div class="text-4xl font-black" id="totalResidences">0</div>
                </div>
            </div>
        </header>

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-gradient-to-br from-orange-500 to-orange-700 rounded-2xl p-6 shadow-xl text-white slide-in">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-orange-100 text-sm font-semibold mb-2">TOTAL PLACES</p>
                        <p class="text-5xl font-black mb-2" id="totalPlaces">0</p>
                        <p class="text-orange-100 text-sm">Capacitat total</p>
                    </div>
                    <svg class="w-14 h-14 opacity-80" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                </div>
            </div>

            <div class="bg-gradient-to-br from-amber-500 to-amber-700 rounded-2xl p-6 shadow-xl text-white slide-in" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-amber-100 text-sm font-semibold mb-2">PLACES MITJANES</p>
                        <p class="text-5xl font-black mb-2" id="avgPlaces">0</p>
                        <p class="text-amber-100 text-sm">Per resid√®ncia</p>
                    </div>
                    <svg class="w-14 h-14 opacity-80" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
            </div>

            <div class="bg-gradient-to-br from-yellow-600 to-yellow-800 rounded-2xl p-6 shadow-xl text-white slide-in" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-yellow-100 text-sm font-semibold mb-2">DISTRICTES</p>
                        <p class="text-5xl font-black mb-2" id="totalDistricts">0</p>
                        <p class="text-yellow-100 text-sm">Amb cobertura</p>
                    </div>
                    <svg class="w-14 h-14 opacity-80" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- Mapa de Barcelona -->
        <div class="bg-white/90 backdrop-blur rounded-2xl shadow-xl p-6 mb-6 border border-orange-200 slide-in" style="animation-delay: 0.3s">
            <h3 class="text-xl font-black text-orange-900 mb-6 flex items-center gap-3">
                <span class="w-1 h-8 bg-gradient-to-b from-orange-500 to-amber-600 rounded-full"></span>
                Mapa de Cobertura per Districtes
            </h3>
            <div class="bg-gradient-to-br from-orange-50 to-amber-50 p-6 rounded-xl">
                <svg id="barcelonaMap" viewBox="0 0 800 600" class="w-full h-[600px] md:h-[700px]">
                    <!-- Los paths se generar√°n din√°micamente -->
                </svg>
                <div class="mt-6 flex flex-wrap gap-4 justify-center text-sm">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-orange-600 to-orange-700 rounded border-2 border-orange-800"></div>
                        <span class="text-gray-700 font-medium">Alta cobertura (3+ resid√®ncies)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-amber-400 to-amber-500 rounded border-2 border-amber-700"></div>
                        <span class="text-gray-700 font-medium">Mitjana (2 resid√®ncies)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-yellow-300 to-yellow-400 rounded border-2 border-yellow-600"></div>
                        <span class="text-gray-700 font-medium">Baixa (1 resid√®ncia)</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gray-200 rounded border-2 border-gray-400"></div>
                        <span class="text-gray-700 font-medium">Sense dades</span>
                    </div>
                </div>
            </div>
            <div id="districtInfo" class="mt-4 p-4 bg-orange-50 rounded-lg hidden">
                <h4 class="font-bold text-orange-900 mb-2" id="infoDistrictName">Selecciona un districte</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-gray-600">Resid√®ncies:</span>
                        <span class="font-bold text-orange-700 ml-2" id="infoResidences"></span>
                    </div>
                    <div>
                        <span class="text-gray-600">Places:</span>
                        <span class="font-bold text-orange-700 ml-2" id="infoPlaces"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="bg-white/90 backdrop-blur rounded-xl shadow-lg p-6 border border-orange-200 slide-in" style="animation-delay: 0.4s">
                <h3 class="text-lg font-semibold text-orange-900 mb-4">Distribuci√≥ per Districte</h3>
                <canvas id="districtChart"></canvas>
            </div>

            <div class="bg-white/90 backdrop-blur rounded-xl shadow-lg p-6 border border-orange-200 slide-in" style="animation-delay: 0.5s">
                <h3 class="text-lg font-semibold text-orange-900 mb-4">Places per Districte</h3>
                <canvas id="placesChart"></canvas>
            </div>
        </div>

        <!-- Residences List -->
        <div class="bg-white/90 backdrop-blur rounded-xl shadow-lg p-6 border border-orange-200 slide-in" style="animation-delay: 0.6s">
            <h3 class="text-lg font-semibold text-orange-900 mb-4">Llista de Resid√®ncies</h3>
            <div class="mb-4">
                <input type="text" id="searchInput" placeholder="Cercar per nom, districte o barri..." 
                    class="w-full px-4 py-2 border border-orange-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
            </div>
            <div id="residencesList" class="space-y-3 max-h-96 overflow-y-auto"></div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 bg-white/70 backdrop-blur-sm rounded-2xl p-6 text-center border border-orange-100">
            <p class="text-gray-600 text-sm mb-2">
                <strong>Font:</strong> Barcelona Open Data - Ajuntament de Barcelona
            </p>
            <p class="text-gray-500 text-xs">
                Dashboard #50opendata 2025 - Envejecimiento Saludable y Longevidad
            </p>
        </footer>
    </div>

    <script>
        let residenciesData = [];

        async function loadData() {
            try {
                if (window.fs && window.fs.readFile) {
                    const response = await window.fs.readFile('./data/residencies.json', { encoding: 'utf8' });
                    const data = JSON.parse(response);
                    residenciesData = Array.isArray(data) ? data : [data];
                } else {
                    const response = await fetch('./data/residencies.json');
                    const data = await response.json();
                    residenciesData = Array.isArray(data) ? data : [data];
                }
                processData();
            } catch (error) {
                console.error('Error carregant dades:', error);
                document.getElementById('residencesList').innerHTML = 
                    '<div class="text-center text-orange-700 py-8">Error carregant les dades. Assegura\'t que el fitxer ./data/residencies.json existeix.</div>';
            }
        }

        function processData() {
            const totalResidences = residenciesData.length;
            
            let totalPlaces = 0;
            const districtCounts = {};
            const districtPlaces = {};

            residenciesData.forEach(res => {
                const placesAttr = res.attribute_categories
                    ?.flatMap(cat => cat.attributes || [])
                    .find(attr => attr.name === "Nombre de  places");
                
                const places = placesAttr?.values?.[0]?.integer_value || 0;
                totalPlaces += places;

                const district = res.addresses?.[0]?.district_name || 'Desconegut';
                districtCounts[district] = (districtCounts[district] || 0) + 1;
                districtPlaces[district] = (districtPlaces[district] || 0) + places;
            });

            const avgPlaces = totalResidences > 0 ? Math.round(totalPlaces / totalResidences) : 0;
            const totalDistricts = Object.keys(districtCounts).length;

            document.getElementById('totalResidences').textContent = totalResidences;
            document.getElementById('totalPlaces').textContent = totalPlaces;
            document.getElementById('avgPlaces').textContent = avgPlaces;
            document.getElementById('totalDistricts').textContent = totalDistricts;

            updateBarcelonaMap(districtCounts, districtPlaces);
            createCharts(districtCounts, districtPlaces);
            renderResidencesList(residenciesData);
        }

        function updateBarcelonaMap(districtCounts, districtPlaces) {
            const districtPaths = {
                'Ciutat Vella': 'M380,320 L440,280 L480,300 L500,340 L460,380 L400,360 Z',
                'Eixample': 'M300,260 L380,320 L400,360 L340,400 L280,340 Z',
                'Sants-Montju√Øc': 'M200,360 L280,340 L340,400 L320,480 L240,460 Z',
                'Les Corts': 'M180,280 L260,260 L300,260 L280,340 L200,360 Z',
                'Sarri√†-Sant Gervasi': 'M180,180 L260,160 L300,200 L280,280 L200,260 Z',
                'Gr√†cia': 'M260,160 L340,140 L380,200 L340,260 L260,260 Z',
                'Horta-Guinard√≥': 'M340,140 L440,100 L480,180 L420,240 L360,200 Z',
                'Nou Barris': 'M280,80 L380,60 L440,100 L380,140 L300,120 Z',
                'Sant Andreu': 'M440,100 L540,80 L580,160 L520,200 L460,180 Z',
                'Sant Mart√≠': 'M480,200 L580,180 L620,280 L560,340 L500,300 Z'
            };

            const svg = document.getElementById('barcelonaMap');
            svg.innerHTML = '';

            Object.entries(districtPaths).forEach(([district, path]) => {
                const count = districtCounts[district] || 0;
                const places = districtPlaces[district] || 0;
                let fillColor, strokeColor;

                if (count >= 3) {
                    fillColor = '#ea580c';
                    strokeColor = '#9a3412';
                } else if (count === 2) {
                    fillColor = '#f59e0b';
                    strokeColor = '#b45309';
                } else if (count === 1) {
                    fillColor = '#fbbf24';
                    strokeColor = '#d97706';
                } else {
                    fillColor = '#e5e7eb';
                    strokeColor = '#9ca3af';
                }

                const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                pathElement.setAttribute('d', path);
                pathElement.setAttribute('fill', fillColor);
                pathElement.setAttribute('stroke', strokeColor);
                pathElement.setAttribute('stroke-width', '3');
                pathElement.setAttribute('opacity', '0.8');
                pathElement.classList.add('cursor-pointer', 'transition-all', 'duration-300');

                pathElement.addEventListener('mouseenter', function() {
                    this.setAttribute('opacity', '1');
                    this.setAttribute('stroke-width', '5');
                });

                pathElement.addEventListener('mouseleave', function() {
                    this.setAttribute('opacity', '0.8');
                    this.setAttribute('stroke-width', '3');
                });

                pathElement.addEventListener('click', function() {
                    showDistrictInfo(district, count, places);
                });

                const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
                title.textContent = `${district}: ${count} resid√®ncia${count !== 1 ? 's' : ''}, ${places} places`;
                pathElement.appendChild(title);

                svg.appendChild(pathElement);

                // A√±adir etiquetas de texto
                const pathBox = pathElement.getBBox();
                const centerX = pathBox.x + pathBox.width / 2;
                const centerY = pathBox.y + pathBox.height / 2;

                const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textElement.setAttribute('x', centerX);
                textElement.setAttribute('y', centerY);
                textElement.setAttribute('text-anchor', 'middle');
                textElement.setAttribute('dominant-baseline', 'middle');
                textElement.setAttribute('class', 'text-xs font-bold pointer-events-none');
                textElement.setAttribute('fill', count >= 2 ? '#ffffff' : '#374151');
                textElement.textContent = district.split('-')[0];
                svg.appendChild(textElement);

                const countElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                countElement.setAttribute('x', centerX);
                countElement.setAttribute('y', centerY + 15);
                countElement.setAttribute('text-anchor', 'middle');
                countElement.setAttribute('dominant-baseline', 'middle');
                countElement.setAttribute('class', 'text-xs font-bold pointer-events-none');
                countElement.setAttribute('fill', count >= 2 ? '#ffffff' : '#6b7280');
                countElement.textContent = `${count} resid√®ncia${count !== 1 ? 's' : ''}`;
                svg.appendChild(countElement);
            });

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', '400');
            text.setAttribute('y', '560');
            text.setAttribute('text-anchor', 'middle');
            text.setAttribute('class', 'text-base font-medium fill-gray-600');
            text.textContent = 'Fes clic en cada districte per veure\'n els detalls';
            svg.appendChild(text);
        }

        function showDistrictInfo(district, count, places) {
            const infoDiv = document.getElementById('districtInfo');
            document.getElementById('infoDistrictName').textContent = district;
            document.getElementById('infoResidences').textContent = count;
            document.getElementById('infoPlaces').textContent = places;
            infoDiv.classList.remove('hidden');
            infoDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function createCharts(districtCounts, districtPlaces) {
            const districts = Object.keys(districtCounts);
            const counts = Object.values(districtCounts);
            const places = Object.values(districtPlaces);

            const chartConfig = {
                type: 'bar',
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(251, 146, 60, 0.1)' } },
                        x: { grid: { display: false } }
                    }
                }
            };

            new Chart(document.getElementById('districtChart'), {
                ...chartConfig,
                data: {
                    labels: districts,
                    datasets: [{
                        label: 'Nombre de Resid√®ncies',
                        data: counts,
                        backgroundColor: 'rgba(251, 146, 60, 0.6)',
                        borderColor: 'rgba(251, 146, 60, 1)',
                        borderWidth: 2
                    }]
                }
            });

            new Chart(document.getElementById('placesChart'), {
                ...chartConfig,
                data: {
                    labels: districts,
                    datasets: [{
                        label: 'Total de Places',
                        data: places,
                        backgroundColor: 'rgba(234, 88, 12, 0.6)',
                        borderColor: 'rgba(234, 88, 12, 1)',
                        borderWidth: 2
                    }]
                }
            });
        }

        function renderResidencesList(data) {
            const container = document.getElementById('residencesList');
            container.innerHTML = data.map(res => {
                const placesAttr = res.attribute_categories
                    ?.flatMap(cat => cat.attributes || [])
                    .find(attr => attr.name === "Nombre de  places");
                
                const places = placesAttr?.values?.[0]?.integer_value || 'N/D';
                const address = res.addresses?.[0] || {};
                const phone = res.values?.find(v => v.attribute_name === "Tel.")?.char_value || 'N/D';
                const email = res.values?.find(v => v.attribute_type === "email")?.email_value || '';

                return `
                    <div class="border border-orange-200 rounded-lg p-4 hover:bg-orange-50 transition">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-orange-900">${res.name}</h4>
                                <p class="text-sm text-orange-700 mt-1">
                                    ${address.address_name || ''} ${address.street_number_1 || ''}, ${address.neighborhood_name || ''}
                                </p>
                                <p class="text-sm text-orange-600 mt-1">
                                    <strong>Districte:</strong> ${address.district_name || 'N/D'}
                                </p>
                                <div class="flex gap-4 mt-2 text-xs text-orange-600">
                                    ${phone !== 'N/D' ? `<span>üìû ${phone}</span>` : ''}
                                    ${email ? `<span>‚úâÔ∏è ${email}</span>` : ''}
                                </div>
                            </div>
                            <div class="text-right ml-4">
                                <div class="bg-orange-100 px-3 py-1 rounded-full">
                                    <span class="text-sm font-semibold text-orange-900">${places} places</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = residenciesData.filter(res => {
                const name = res.name?.toLowerCase() || '';
                const district = res.addresses?.[0]?.district_name?.toLowerCase() || '';
                const neighborhood = res.addresses?.[0]?.neighborhood_name?.toLowerCase() || '';
                return name.includes(searchTerm) || district.includes(searchTerm) || neighborhood.includes(searchTerm);
            });
            renderResidencesList(filtered);
        });

        loadData();
    </script>
</body>
</html>